// Package provider implements acceptance tests for database_workspace resource
package provider

import (
	"fmt"
	"testing"

	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
)

// TestAccDatabaseWorkspace_basic tests basic CRUD lifecycle for database target resource
func TestAccDatabaseWorkspace_basic(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Create and Read testing
			{
				Config: testAccDatabaseWorkspaceConfig_basic,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "name", "test-postgres-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "database_type", "postgres"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "address", "postgres.example.com"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "port", "5432"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "authentication_method", "local_ephemeral_user"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.test", "cloud_provider", "on_premise"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.test", "id"),
				),
			},
			// ImportState testing
			{
				ResourceName:      "cyberark_sia_database_workspace.test",
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

// TestAccDatabaseWorkspace_awsRDS tests AWS RDS PostgreSQL configuration
func TestAccDatabaseWorkspace_awsRDS(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccDatabaseWorkspaceConfig_awsRDS,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.aws_rds", "name", "aws-rds-postgres"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.aws_rds", "database_type", "postgres-aws-rds"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.aws_rds", "cloud_provider", "aws"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.aws_rds", "region", "us-east-1"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.aws_rds", "id"),
				),
			},
		},
	})
}

// TestAccDatabaseWorkspace_azureSQL tests Azure SQL Server configuration
func TestAccDatabaseWorkspace_azureSQL(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccDatabaseWorkspaceConfig_azureSQL,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.azure_sql", "name", "azure-sqlserver"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.azure_sql", "database_type", "mssql"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.azure_sql", "cloud_provider", "azure"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.azure_sql", "authentication_method", "ad_ephemeral_user"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.azure_sql", "id"),
				),
			},
		},
	})
}

// TestAccDatabaseWorkspace_onPremise tests on-premise Oracle configuration
func TestAccDatabaseWorkspace_onPremise(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccDatabaseWorkspaceConfig_onPremise,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "name", "onprem-oracle-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "database_type", "oracle"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "address", "oracle.internal.example.com"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "port", "1521"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "cloud_provider", "on_premise"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.oracle", "id"),
				),
			},
		},
	})
}

// TestAccDatabaseWorkspace_import tests ImportState functionality
func TestAccDatabaseWorkspace_import(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Create resource
			{
				Config: testAccDatabaseWorkspaceConfig_basic,
			},
			// Test import
			{
				ResourceName:      "cyberark_sia_database_workspace.test",
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

// TestAccDatabaseWorkspace_multipleDatabaseTypes tests various database types
func TestAccDatabaseWorkspace_multipleDatabaseTypes(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccDatabaseWorkspaceConfig_multipleTypes,
				Check: resource.ComposeAggregateTestCheckFunc(
					// PostgreSQL
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.postgres", "database_type", "postgres"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.postgres", "port", "5432"),
					// MySQL
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mysql", "database_type", "mysql"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mysql", "port", "3306"),
					// MariaDB
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mariadb", "database_type", "mariadb"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mariadb", "port", "3306"),
					// MongoDB
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mongodb", "database_type", "mongo"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.mongodb", "port", "27017"),
					// Oracle
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "database_type", "oracle"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.oracle", "port", "1521"),
					// SQL Server
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.sqlserver", "database_type", "mssql"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.sqlserver", "port", "1433"),
					// Db2
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.db2", "database_type", "db2"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.db2", "port", "50000"),
				),
			},
		},
	})
}

// Test configurations

const testAccDatabaseWorkspaceConfig_basic = `
resource "cyberark_sia_database_workspace" "test" {
  name                  = "test-postgres-db"
  database_type         = "postgres"
  address               = "postgres.example.com"
  port                  = 5432
  authentication_method = "local_ephemeral_user"
  cloud_provider        = "on_premise"
}
`

const testAccDatabaseWorkspaceConfig_awsRDS = `
resource "cyberark_sia_database_workspace" "aws_rds" {
  name                  = "aws-rds-postgres"
  database_type         = "postgres-aws-rds"
  address               = "mydb.abc123.us-east-1.rds.amazonaws.com"
  port                  = 5432
  authentication_method = "rds_iam_authentication"
  cloud_provider        = "aws"
  region                = "us-east-1"
}
`

const testAccDatabaseWorkspaceConfig_azureSQL = `
resource "cyberark_sia_database_workspace" "azure_sql" {
  name                  = "azure-sqlserver"
  database_type         = "mssql"
  address               = "sqlserver-prod.database.windows.net"
  port                  = 1433
  authentication_method = "ad_ephemeral_user"
  cloud_provider        = "azure"
}
`

const testAccDatabaseWorkspaceConfig_onPremise = `
resource "cyberark_sia_database_workspace" "oracle" {
  name                  = "onprem-oracle-db"
  database_type         = "oracle"
  address               = "oracle.internal.example.com"
  port                  = 1521
  authentication_method = "local_ephemeral_user"
  cloud_provider        = "on_premise"
}
`

const testAccDatabaseWorkspaceConfig_multipleTypes = `
resource "cyberark_sia_database_workspace" "postgres" {
  name              = "test-postgres"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "mysql" {
  name              = "test-mysql"
  database_type     = "mysql"
  database_version  = "8.0.0"
  address           = "mysql.example.com"
  port              = 3306
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "mariadb" {
  name              = "test-mariadb"
  database_type     = "mariadb"
  database_version  = "10.6.0"
  address           = "mariadb.example.com"
  port              = 3306
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "mongodb" {
  name              = "test-mongodb"
  database_type     = "mongodb"
  database_version  = "5.0.0"
  address           = "mongodb.example.com"
  port              = 27017
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "oracle" {
  name              = "test-oracle"
  database_type     = "oracle"
  database_version  = "19.3.0"
  address           = "oracle.example.com"
  port              = 1521
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "sqlserver" {
  name              = "test-sqlserver"
  database_type     = "sqlserver"
  database_version  = "13.0.0"
  address           = "sqlserver.example.com"
  port              = 1433
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "db2" {
  name              = "test-db2"
  database_type     = "db2"
  database_version  = "11.5.0"
  address           = "db2.example.com"
  port              = 50000
  authentication_method = "local"
  cloud_provider    = "on_premise"
}
`

// ============================================================================
// Phase 5 (User Story 3) Tests: Update, Delete, ForceNew, Drift Detection
// ============================================================================

// T060: TestAccDatabaseWorkspace_update tests configuration update functionality
func TestAccDatabaseWorkspace_update(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Step 1: Create initial resource
			{
				Config: testAccDatabaseWorkspaceConfig_beforeUpdate,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "name", "update-test-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "port", "5432"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "description", "Initial description"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "authentication_method", "local"),
				),
			},
			// Step 2: Update port and description (in-place update)
			{
				Config: testAccDatabaseWorkspaceConfig_afterUpdate,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "name", "update-test-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "port", "5433"),                                  // Changed
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "description", "Updated description"),            // Changed
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.update_test", "authentication_method", "local_ephemeral_user"), // Changed
				),
			},
			// Step 3: Verify import still works after update
			{
				ResourceName:      "cyberark_sia_database_workspace.update_test",
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

// T061: TestAccDatabaseWorkspace_forceNew tests ForceNew behavior for immutable attributes
func TestAccDatabaseWorkspace_forceNew(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Step 1: Create with postgresql
			{
				Config: testAccDatabaseWorkspaceConfig_forceNew_before,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.forcenew_test", "database_type", "postgresql"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.forcenew_test", "id"),
				),
			},
			// Step 2: Change database_type (should trigger replacement)
			// Note: Changing database_type should cause destroy-and-recreate
			{
				Config: testAccDatabaseWorkspaceConfig_forceNew_after,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.forcenew_test", "database_type", "mysql"),
					// ID should be different due to resource replacement
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.forcenew_test", "id"),
				),
			},
		},
	})
}

// T062: TestAccDatabaseWorkspace_noOpUpdate tests plan-only operation (no-op update)
func TestAccDatabaseWorkspace_noOpUpdate(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Step 1: Create resource
			{
				Config: testAccDatabaseWorkspaceConfig_noop,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.noop_test", "name", "noop-test-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.noop_test", "port", "5432"),
				),
			},
			// Step 2: Apply same config again (should be no-op)
			{
				Config:   testAccDatabaseWorkspaceConfig_noop,
				PlanOnly: true, // Verify no changes planned
			},
			// Step 3: Apply with ExpectNonEmptyPlan=false to verify no changes
			{
				Config:             testAccDatabaseWorkspaceConfig_noop,
				ExpectNonEmptyPlan: false, // No changes should be detected
			},
		},
	})
}

// T063: TestAccDatabaseWorkspace_concurrent tests concurrent resource operations
func TestAccDatabaseWorkspace_concurrent(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Create multiple resources concurrently
			{
				Config: testAccDatabaseWorkspaceConfig_concurrent,
				Check: resource.ComposeAggregateTestCheckFunc(
					// Verify all resources created successfully
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.concurrent1", "id"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.concurrent2", "id"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.concurrent3", "id"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.concurrent4", "id"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.concurrent5", "id"),
					// Verify each has correct type
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.concurrent1", "database_type", "postgresql"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.concurrent2", "database_type", "mysql"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.concurrent3", "database_type", "mariadb"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.concurrent4", "database_type", "mongodb"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.concurrent5", "database_type", "oracle"),
				),
			},
		},
	})
}

// T064: TestAccDatabaseWorkspace_driftDetection tests state drift detection
func TestAccDatabaseWorkspace_driftDetection(t *testing.T) {
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			// Step 1: Create resource
			{
				Config: testAccDatabaseWorkspaceConfig_drift,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.drift_test", "name", "drift-test-db"),
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.drift_test", "port", "5432"),
					resource.TestCheckResourceAttrSet("cyberark_sia_database_workspace.drift_test", "id"),
				),
			},
			// Step 2: Refresh state (should detect if resource was modified outside Terraform)
			// Note: In a real test, you would manually modify the resource in SIA between steps
			// For now, this verifies the refresh mechanism works
			{
				Config:   testAccDatabaseWorkspaceConfig_drift,
				PlanOnly: true,
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("cyberark_sia_database_workspace.drift_test", "name", "drift-test-db"),
				),
			},
		},
	})
}

// Test configurations for Phase 5 (User Story 3)

const testAccDatabaseWorkspaceConfig_beforeUpdate = `
resource "cyberark_sia_database_workspace" "update_test" {
  name              = "update-test-db"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres-update.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"
  description       = "Initial description"

  tags = {
    Environment = "test"
    Phase       = "before-update"
  }
}
`

const testAccDatabaseWorkspaceConfig_afterUpdate = `
resource "cyberark_sia_database_workspace" "update_test" {
  name              = "update-test-db"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres-update.example.com"
  port              = 5433
  authentication_method = "local_ephemeral_user"
  cloud_provider    = "on_premise"
  description       = "Updated description"

  tags = {
    Environment = "test"
    Phase       = "after-update"
    Updated     = "true"
  }
}
`

const testAccDatabaseWorkspaceConfig_forceNew_before = `
resource "cyberark_sia_database_workspace" "forcenew_test" {
  name              = "forcenew-test-db"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "db-forcenew.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"
}
`

const testAccDatabaseWorkspaceConfig_forceNew_after = `
resource "cyberark_sia_database_workspace" "forcenew_test" {
  name              = "forcenew-test-db"
  database_type     = "mysql"
  database_version  = "8.0.0"
  address           = "db-forcenew.example.com"
  port              = 3306
  authentication_method = "local"
  cloud_provider    = "on_premise"
}
`

const testAccDatabaseWorkspaceConfig_noop = `
resource "cyberark_sia_database_workspace" "noop_test" {
  name              = "noop-test-db"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres-noop.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"

  description = "No-op test database"

  tags = {
    Environment = "test"
    TestType    = "noop"
  }
}
`

const testAccDatabaseWorkspaceConfig_concurrent = `
resource "cyberark_sia_database_workspace" "concurrent1" {
  name              = "concurrent-postgres"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres-concurrent.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "concurrent2" {
  name              = "concurrent-mysql"
  database_type     = "mysql"
  database_version  = "8.0.0"
  address           = "mysql-concurrent.example.com"
  port              = 3306
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "concurrent3" {
  name              = "concurrent-mariadb"
  database_type     = "mariadb"
  database_version  = "10.6.0"
  address           = "mariadb-concurrent.example.com"
  port              = 3306
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "concurrent4" {
  name              = "concurrent-mongodb"
  database_type     = "mongodb"
  database_version  = "5.0.0"
  address           = "mongodb-concurrent.example.com"
  port              = 27017
  authentication_method = "local"
  cloud_provider    = "on_premise"
}

resource "cyberark_sia_database_workspace" "concurrent5" {
  name              = "concurrent-oracle"
  database_type     = "oracle"
  database_version  = "19.3.0"
  address           = "oracle-concurrent.example.com"
  port              = 1521
  authentication_method = "local"
  cloud_provider    = "on_premise"
}
`

const testAccDatabaseWorkspaceConfig_drift = `
resource "cyberark_sia_database_workspace" "drift_test" {
  name              = "drift-test-db"
  database_type     = "postgresql"
  database_version  = "14.0.0"
  address           = "postgres-drift.example.com"
  port              = 5432
  authentication_method = "local"
  cloud_provider    = "on_premise"

  description = "Drift detection test database"

  tags = {
    Environment = "test"
    TestType    = "drift"
  }
}
`
