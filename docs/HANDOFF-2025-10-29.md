# Handoff Document: Days of Week Drift Fix
**Date**: 2025-10-29
**Branch**: `002-sia-policy-lifecycle`
**Context Window**: Near exhaustion, stopping for next session

---

## Current Status: PARTIALLY WORKING ⚠️

### ✅ What's Fixed
1. **days_of_the_week ordering** - Sorting implemented, works correctly
2. **Case normalization** (status, delegation_classification) - Works correctly
3. **Provider binary management** - Cleaned up 6 obsolete namespace directories (saved 224 MB)

### ❌ Current Blocker
**Error**: "Value Conversion Error" for computed fields `created_by` and `updated_on`
```
Path: created_by
Target Type: *models.ChangeInfoModel
Suggested Type: basetypes.ObjectValue
```

**Why it fails**:
- During CREATE, Terraform sets computed fields to "unknown" in the plan
- When `resp.State.Set(ctx, &data)` is called, it tries to convert "unknown" → `*ChangeInfoModel`
- Struct pointers can't represent "unknown" values (only `nil` or concrete values)

---

## Work Completed This Session

### 1. Initial SetAttribute Implementation (Commit e7d8fa7)
**Changed**: `days_of_the_week` from `ListAttribute` to `SetAttribute`
**Files**:
- `internal/provider/database_policy_resource.go:354` - Schema change
- `internal/models/database_policy.go:68` - Model field type change
- Deleted `internal/provider/types/days_of_week.go` (192 lines - workaround no longer needed)

**Result**: Failed - still got "inconsistent result" errors

### 2. Sorting and Case Normalization (Commit 73712c0) ✅ SUCCESSFUL
**Problem Identified by Codex**:
- SetAttribute doesn't prevent positional comparison during plan/state validation
- API returns titlecase, config uses lowercase

**Solution Implemented**:
```go
// internal/models/database_policy.go

// ToSDK (line 222) - Sort before sending to API
sort.Slice(daysInt64, func(i, j int) bool { return daysInt64[i] < daysInt64[j] })

// FromSDK (line 262) - Sort after receiving from API
sort.Slice(daysInt64, func(i, j int) bool { return daysInt64[i] < daysInt64[j] })

// FromSDK (lines 156, 159) - Normalize case
m.Status = types.StringValue(strings.ToLower(policy.Metadata.Status.Status))
m.DelegationClassification = types.StringValue(strings.ToLower(policy.DelegationClassification))
```

**Result**: ✅ Fixed ordering and case issues. Revealed new computed fields issue.

### 3. Computed Fields Fix Attempt (NOT COMMITTED)
**Modified**: `internal/provider/database_policy_resource.go:614-629`
**Change**: Removed `FromSDK()` call in Create(), only set ID fields manually
**Result**: ❌ Still fails - need to explicitly set `created_by`/`updated_on` to `nil`

---

## Critical Files and Their State

### `internal/models/database_policy.go`
**Status**: Committed (73712c0), working correctly
**Key sections**:
- Lines 7-8: Imports `sort` and `strings`
- Lines 156, 159: Case normalization (FromSDK)
- Lines 222: Sorting in ToSDK
- Lines 262: Sorting in FromSDK

### `internal/provider/database_policy_resource.go`
**Status**: Modified but NOT committed
**Line 615**: ~~`if err := data.FromSDK(ctx, createdPolicy); err != nil {`~~ (REMOVED)
**Lines 618-619**: Added manual ID field setting
**Lines 632**: `resp.State.Set(ctx, &data)` - This is where the error occurs

**NEEDS**: Add before line 632:
```go
// Explicitly set computed metadata fields to nil to avoid "unknown value" errors
data.CreatedBy = nil
data.UpdatedOn = nil
```

### `examples/testing/TESTING-GUIDE.md`
**Status**: Modified but NOT staged (premature "FIXED" claim)
**Action needed**: Revert changes or update only after full testing passes

---

## Test Environment Setup

### Current Test Location
```bash
cd /tmp/days-test
```

### Test Configuration (`main.tf`)
```hcl
resource "cyberarksia_database_policy" "drift_test" {
  name                       = "Days-Drift-Test"
  description                = "Testing SetAttribute with random order [5,1,3,2,4]"
  status                     = "active"  # Lowercase
  delegation_classification  = "unrestricted"  # Lowercase

  conditions {
    access_window {
      days_of_the_week = [5, 1, 3, 2, 4]  # Random order - now works!
      from_hour        = "09:00"
      to_hour          = "17:00"
    }
    # ... other fields
  }
  # ... other blocks
}
```

### Required Resources (Already Created)
- ✅ `cyberarksia_secret.test` - ID: 914f10ad-8a98-4d0c-a4ce-bd69949f3544
- ✅ `cyberarksia_certificate.test` - ID: 1761724747687472
- ✅ `cyberarksia_database_workspace.test` - ID: 193521

### Provider Binary Management
**IMPORTANT**: `go install` puts binary in `~/go/bin/`, but Terraform uses `~/.terraform.d/plugins/`

**Rebuild workflow**:
```bash
cd ~/terraform-provider-cyberark-sia
go build -v && go install
cp ~/go/bin/terraform-provider-cyberark-sia \
   ~/.terraform.d/plugins/terraform.local/local/cyberark-sia/0.1.0/linux_amd64/

cd /tmp/days-test
rm -rf .terraform*
terraform init
terraform apply -auto-approve
```

### Verify Binary Timestamps
```bash
stat ~/go/bin/terraform-provider-cyberark-sia | grep Modify
stat ~/.terraform.d/plugins/terraform.local/local/cyberark-sia/0.1.0/linux_amd64/terraform-provider-cyberark-sia | grep Modify
```
**Both should match** (currently: Oct 29 10:44)

---

## Next Steps (Priority Order)

### 1. Fix Computed Fields Error (HIGHEST PRIORITY)
**File**: `internal/provider/database_policy_resource.go`
**Location**: Line 632 (before `resp.State.Set`)

**Add these lines**:
```go
// Explicitly set computed metadata fields to nil to avoid "unknown value" errors
// These will be populated by the automatic Read() call after Create()
data.CreatedBy = nil
data.UpdatedOn = nil
```

**Then**:
- Rebuild: `go build -v && go install`
- Copy: `cp ~/go/bin/terraform-provider-cyberark-sia ~/.terraform.d/plugins/...`
- Test: `cd /tmp/days-test && rm -rf .terraform* && terraform init && terraform apply -auto-approve`

### 2. Verify Full CRUD Cycle
If fix #1 succeeds:
- **CREATE**: Should succeed without errors
- **READ**: Check metadata fields populated (`terraform show`)
- **REFRESH**: Run `terraform plan` - should show no changes
- **UPDATE**: Change days order in config, verify no drift
- **DELETE**: Clean up test resources

### 3. Commit Computed Fields Fix
```bash
cd ~/terraform-provider-cyberark-sia
git add internal/provider/database_policy_resource.go
git commit -m "fix(policy): skip computed metadata during CREATE to avoid unknown value errors"
```

### 4. Update Documentation (TESTING-GUIDE.md)
Only after ALL tests pass:
- Update "Known Limitation" section to "FIXED ✅"
- Add examples showing random day order works
- Document that metadata appears after Read() call

### 5. Final Testing Checklist
- [ ] CREATE with random day order [5,1,3,2,4] - succeeds
- [ ] State shows sorted days [1,2,3,4,5]
- [ ] terraform plan shows no drift
- [ ] Change to different random order [3,5,1,4,2] - no drift
- [ ] Change actual days [1,2,3] → [2,3,4] - detects change
- [ ] Metadata fields visible after CREATE (`terraform show`)

---

## Key Learnings and Gotchas

### 1. SetAttribute Doesn't Automatically Fix Ordering
**Myth**: "SetAttribute means order doesn't matter"
**Reality**: Framework compares underlying slice representation positionally during CREATE validation
**Solution**: Manual sorting in both ToSDK and FromSDK

### 2. Binary Location Trap
**Problem**: `go install` → `~/go/bin/`, Terraform uses `~/.terraform.d/plugins/`
**Solution**: Always `cp` after `go install`, verify timestamps match

### 3. Computed Fields Can't Be "Unknown"
**Problem**: Struct pointers (`*ChangeInfoModel`) can't represent unknown values
**Solution**: Set to `nil` during CREATE, let Read() populate them

### 4. Case Normalization Location
**Why FromSDK only**: API accepts any case, so we normalize when reading into state
**Could also normalize in ToSDK**: Would be more explicit bidirectional normalization

### 5. Terraform Lifecycle During CREATE
```
User Config → PLAN (unknown computed fields)
  ↓
CREATE API call
  ↓
Provider returns state (tries to convert unknown → struct) ← ERROR HERE
  ↓
Read() called automatically (populates computed fields)
```

---

## Codex Consultation Summary

**Asked**: Why SetAttribute still shows positional comparison errors?
**Answer**: Framework compares underlying slice; need manual sorting

**Recommendation**: Keep current simple solution (sorting + case normalization)
**Rejected**: PlanModifiers, custom types (over-engineering for 2 fields)

---

## Files Modified (Not Committed)
```
M  internal/provider/database_policy_resource.go (computed fields fix)
M  examples/testing/TESTING-GUIDE.md (premature "FIXED" claim - revert or hold)
```

## Commits This Session
```
73712c0 fix(policy): add sorting and case normalization for plan/state consistency
e7d8fa7 feat(policy): change days_of_the_week from ListAttribute to SetAttribute
```

---

## Test Logs
- `/tmp/test-final.log` - First failure (wrong binary)
- `/tmp/test1-retry.log` - With sorting (still failing - case issues)
- `/tmp/test-after-cleanup.log` - After binary cleanup (computed fields error)
- `/tmp/test-computed-fields-fix.log` - Current blocker

---

## Environment Context
- **Tenant**: timtest@cyberark.cloud.40562
- **Working Directory**: /tmp/days-test
- **Provider Source**: terraform.local/local/cyberark-sia
- **Go Version**: 1.25.0
- **Provider Version**: 0.1.0

---

## Quick Resume Commands

### Resume Working
```bash
# 1. Navigate to provider source
cd ~/terraform-provider-cyberark-sia

# 2. Check current branch and status
git status
git log --oneline -5

# 3. Add the nil assignment fix (see Next Steps #1)
# Edit internal/provider/database_policy_resource.go line 632

# 4. Build, install, copy
go build -v && go install
cp ~/go/bin/terraform-provider-cyberark-sia ~/.terraform.d/plugins/terraform.local/local/cyberark-sia/0.1.0/linux_amd64/

# 5. Test
cd /tmp/days-test
rm -rf .terraform*
terraform init
terraform apply -auto-approve

# 6. If successful, commit
cd ~/terraform-provider-cyberark-sia
git add internal/provider/database_policy_resource.go
git commit -m "fix(policy): skip computed metadata during CREATE to avoid unknown value errors"
```

---

## Success Criteria
When you see:
```
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

And `terraform show` displays:
```hcl
created_by = {
  timestamp = "2025-10-29T..."
  user      = "timtest@cyberark.cloud.40562"
}
```

**Then the fix is complete!** ✅

---

**END OF HANDOFF**
